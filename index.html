<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>HABD-WILD EM — v8 (Supabase snapshots, ASSETS static)</title>

<style>
  :root { --bg:#0f1116; --panel:#161b26; --ink:#e9ecf2; --muted:#9aa3b2; --border:#2a2f3a; --accent:#7aa2f7 }
  * { box-sizing:border-box }
  body { margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial }
  header { background:var(--panel); border-bottom:1px solid var(--border); padding:14px 18px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:center }
  .tabs { display:flex; gap:8px; flex-wrap:wrap }
  .tab-btn { border:1px solid var(--border); background:transparent; color:var(--ink); padding:8px 10px; border-radius:8px; cursor:pointer }
  .tab-btn.active { background:var(--accent); color:#0b1021; border-color:var(--accent) }
  main { padding:14px 16px 36px }
  .tab { display:none } .tab.active { display:block }
  .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:12px; margin:10px 0 }
  .control { display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap }
  input,select,textarea { background:#0e1220; color:var(--ink); border:1px solid var(--border); border-radius:8px; padding:8px }
  table { border-collapse: collapse; width:100% }
  th,td { padding:6px; border-bottom:1px solid var(--border); white-space:nowrap }
  thead th { position:sticky; top:0; background:#121622; z-index:1 }
  .table-scroll { overflow:auto; max-height:65vh; border:1px solid var(--border); border-radius:10px }
  .badge { display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid var(--border) }
  .g { background:#0f2a16; border-color:#245a37 }
  .r { background:#2a1111; border-color:#5e2626 }
  .btn { background:var(--accent); color:#0b1021; border:none; padding:8px 10px; border-radius:8px; cursor:pointer }
  .btn.ghost { background:transparent; color:var(--ink); border:1px solid var(--border) }
  .btn.small { padding:4px 8px; font-size:12px }
  .fit { width:100% }
  .w160 { width:160px }
  .no-print { display:inline-flex }

  /* Hide test bar entirely */
  #sb-test-bar { display:none !important }

  /* === FORM PAGES (A4 single page) === */
  @page { size: A4; margin: 8mm }
  .a4 { width: 190mm; margin: 0 auto; background:#fff; color:#000; }
  .form-sheet { border:0.75pt solid #005172; padding:6mm; font-family: Arial, Helvetica, sans-serif; }
  .np-head-left { background:#ccffcc; }
  .np-head-right { background:#009900; color:#fff; text-align:left }
  .np-slab { background:#3a9fbe; color:#fff; font-weight:700 }
  .np-border { border:0.75pt solid #005172 }
  .np-box { min-height:7mm; border:0.75pt solid #005172; padding:3mm 4mm; }
  .h-grid td { vertical-align:top; }
  .xcell { text-align:center; font-weight:bold; }
  .np-footer { border-top:0.75pt solid #808080; padding-top:1pt; font-size:10pt; }
  .tight { padding:2mm 3mm }
  .np-title { text-align:center; font-weight:700 }
  .np-hr { height:2mm }

  /* Print clean: only the form content */
  @media print {
    header, .tabs, .panel > .control, .no-print, #sb-test-bar { display:none !important }
    body { background:#fff; color:#000 }
    main { padding:0 }
    .panel { border:none; padding:0; margin:0 }
    .a4 { border:none; width:auto }
    a { text-decoration:none; color:#000 }
  }
</style>

<!-- html2pdf: used to render A4 PDFs client-side -->
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
</head>

<body>
<header>
  <h3 style="margin:0">HABD-WILD EM — v8</h3>

  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-overview">Overview</button>
    <button class="tab-btn" data-tab="tab-faultlog">Fault Log</button>
    <button class="tab-btn" data-tab="tab-f321a">F3.21A</button>
    <button class="tab-btn" data-tab="tab-f321b">F3.21B</button>
  </div>

  <!-- Just the toggle now; email is baked in -->
  <div class="no-print" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;font-size:12px;color:var(--muted);">
    <label>
      Auto-email PDFs to <span style="color:var(--ink);font-weight:500;">bradley.garner@networkrail.co.uk</span>
      <input id="auto-mail-toggle" type="checkbox" style="vertical-align:middle;margin-left:6px">
    </label>
  </div>
</header>

<main>
  <!-- OVERVIEW -->
  <section id="tab-overview" class="tab active">
    <div class="panel">
      <div class="control">
        <input id="ovr-q" placeholder="Search assets" class="fit">
        <span id="ovr-count" class="badge"></span>
        <button class="btn ghost no-print" onclick="csvAssets()">Export visible CSV</button>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr id="ovr-head"></tr></thead>
          <tbody id="ovr-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- FAULT LOG -->
  <section id="tab-faultlog" class="tab">
    <div class="panel">
      <div class="control">
        <select id="book-id" class="w160"></select>
        <input id="book-fms" class="w160" placeholder="FMS ref" style="min-width:110px">
        <input id="book-fail" class="w160" type="datetime-local" placeholder="Failure date/time">
        <input id="book-notes" class="fit" placeholder="Notes (free text)">
        <button class="btn" onclick="bookFault()">Book fault</button>
        <button class="btn ghost" onclick="exportBackup()">Export backup (JSON)</button>
      </div>
      <div class="control">
        <input id="flt-q" placeholder="Search faults" class="fit">
        <span id="flt-count" class="badge"></span>
        <button class="btn ghost no-print" onclick="csvFaults()">Export visible CSV</button>
      </div>
      <div class="control">
        <select id="close-id" class="w160"></select>
        <button class="btn no-print" onclick="closeAllForId()">Close open faults for ID (stamp now)</button>
      </div>
      <div class="table-scroll">
        <table>
          <thead><tr id="flt-head"></tr></thead>
          <tbody id="flt-body"></tbody>
        </table>
      </div>
      <div style="margin-top:6px; color:var(--muted); font-size:12px">Editable: FMS, Failure Date, Date in order, Notes. Open = Date in order blank. Use “Close now” per-row or bulk close by ID.</div>
    </div>
  </section>

  <!-- ==================== F3.21A ==================== -->
  <section id="tab-f321a" class="tab">
    <div class="panel">
      <div class="control no-print">
        <select id="a-fin" class="w160"></select>
        <input id="a-signed" class="w160" placeholder="Signed by">
        <button class="btn" onclick="window.print()">Print to PDF</button>
      </div>

      <div class="a4">
        <div class="form-sheet" id="formA">
          <table class="np-border" style="width:100%; border-collapse:collapse">
            <tr>
              <td class="np-head-left np-border" style="width:75%; padding:6px;">
                <div style="font-weight:700; font-size:14pt">NATIONAL OPERATING PROCEDURES</div>
                <div style="font-weight:700; font-size:11pt; margin-top:2px">ADVICE OF SYSTEM OUTAGE (FAILURE OR DISCONNECTION)</div>
              </td>
              <td class="np-head-right np-border" style="width:25%; padding:6px;">
                <div><strong>Form:</strong>&nbsp;F3.21A</div>
                <div><strong>Issue:</strong>&nbsp;01</div>
                <div><strong>Date:</strong>&nbsp;02/09/17</div>
              </td>
            </tr>
          </table>

          <div class="np-hr"></div>
          <div class="np-title">DEFECTIVE HOT AXLE BOX DETECTOR (HABD) or WHEEL IMPACT LOAD DETECTOR (WILD)</div>
          <div class="np-title" style="text-transform:uppercase; margin-top:2mm;">Advice of System Outage (Failure or Disconnection)</div>
          <div class="np-title" style="margin-top:2mm;"><strong>Unique reference No:&nbsp;
            <span id="a-uniq" class="np-box" style="display:inline-block; min-width:40mm"></span></strong>
          </div>

          <table class="np-border h-grid" style="width:100%; margin-top:4mm; border-collapse:collapse">
            <tr>
              <td class="np-slab np-border" style="width:16%"><div class="tight">SYSTEM :</div></td>
              <td class="np-border" style="width:22%"><div class="tight">Hot Axle Box Detector</div></td>
              <td class="np-border" style="width:10%"><div id="a-x-habd" class="xcell tight">&nbsp;</div></td>
              <td class="np-border" style="width:30%"><div class="tight">Wheel Impact Load Detector</div></td>
              <td class="np-border" style="width:10%"><div id="a-x-wild" class="xcell tight">&nbsp;</div></td>
            </tr>
            <tr><td colspan="5" class="np-border" style="height:10mm"></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">TIME:</div></td><td colspan="4" class="np-border"><div id="a-time" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">DATE:</div></td><td colspan="4" class="np-border"><div id="a-date" class="tight"></div></td></tr>
          </table>

          <table class="np-border h-grid" style="width:100%; margin-top:6mm; border-collapse:collapse">
            <tr><td class="np-slab np-border" style="width:16%"><div class="tight">Route:</div></td><td class="np-border"><div id="a-route" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">ELR:</div></td><td class="np-border"><div id="a-elr" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">Location:</div></td><td class="np-border"><div id="a-loc" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">Line:</div></td><td class="np-border"><div id="a-line" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">Miles / Chains:</div></td><td class="np-border"><div id="a-miles" class="tight"></div></td></tr>
          </table>

          <div style="margin:10mm 0 12mm 0;">
            I will advise you when the system is reinstated but in the meantime, please apply your company maintenance instructions for vehicles that use this route.
          </div>

          <table class="np-border h-grid" style="width:100%; border-collapse:collapse">
            <tr>
              <td class="np-slab np-border" style="width:12%"><div class="tight">SIGNED:</div></td>
              <td class="np-border" style="width:60%"><div id="a-signed-val" class="tight"></div></td>
              <td class="np-slab np-border" style="width:10%"><div class="tight">DATE:</div></td>
              <td class="np-border" style="width:18%"><div id="a-signed-date" class="tight"></div></td>
            </tr>
          </table>

          <div class="np-footer" style="margin-top:6mm;">
            <strong>System Operations – NOP F3.21A</strong><span style="display:inline-block; width:50%"></span><strong>Page:</strong> 1 of 1
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ==================== F3.21B ==================== -->
  <section id="tab-f321b" class="tab">
    <div class="panel">
      <div class="control no-print">
        <select id="b-fin" class="w160"></select>
        <input id="b-signed" class="w160" placeholder="Signed by">
        <button class="btn" onclick="window.print()">Print to PDF</button>
      </div>

      <div class="a4">
        <div class="form-sheet" id="formB">
          <table class="np-border" style="width:100%; border-collapse:collapse">
            <tr>
              <td class="np-head-left np-border" style="width:75%; padding:6px;">
                <div style="font-weight:700; font-size:14pt">NATIONAL OPERATING PROCEDURES</div>
                <div style="font-weight:700; font-size:11pt; margin-top:2px">ADVICE OF SYSTEM REINSTATEMENT</div>
              </td>
              <td class="np-head-right np-border" style="width:25%; padding:6px;">
                <div><strong>Form:</strong>&nbsp;F3.21B</div>
                <div><strong>Issue:</strong>&nbsp;01</div>
                <div><strong>Date:</strong>&nbsp;02/09/17</div>
              </td>
            </tr>
          </table>

          <div class="np-hr"></div>
          <div class="np-title" style="text-transform:uppercase;">Defective Hot Axle Box Detector (HABD) or WHEEL IMPACT LOAD DETECTOR (WILD)</div>
          <div class="np-title" style="text-transform:uppercase; margin-top:2mm;">Advice of SYSTEM Reinstatement</div>
          <div class="np-title" style="margin-top:2mm;"><strong>Unique reference No:&nbsp;
            <span id="b-uniq" class="np-box" style="display:inline-block; min-width:40mm"></span></strong>
          </div>

          <div style="margin-top:4mm;">Please note the HABD or WILD equipment, which was advised to you under the above reference as being out of use from:</div>

          <table class="np-border h-grid" style="width:100%; margin-top:4mm; border-collapse:collapse">
            <tr><td class="np-slab np-border" style="width:18%"><div class="tight">TIME:</div></td><td class="np-border"><div id="b-from-time" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">DATE:</div></td><td class="np-border"><div id="b-from-date" class="tight"></div></td></tr>
          </table>

          <div style="margin-top:6mm;">has been reinstated:</div>

          <table class="np-border h-grid" style="width:100%; margin-top:4mm; border-collapse:collapse">
            <tr><td class="np-slab np-border" style="width:18%"><div class="tight">TIME:</div></td><td class="np-border"><div id="b-to-time" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">DATE:</div></td><td class="np-border"><div id="b-to-date" class="tight"></div></td></tr>
          </table>

          <table class="np-border h-grid" style="width:100%; margin-top:6mm; border-collapse:collapse">
            <tr><td class="np-slab np-border" style="width:18%"><div class="tight">Route:</div></td><td class="np-border"><div id="b-route" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">ELR:</div></td><td class="np-border"><div id="b-elr" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">Location:</div></td><td class="np-border"><div id="b-loc" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">Line:</div></td><td class="np-border"><div id="b-line" class="tight"></div></td></tr>
            <tr><td class="np-slab np-border"><div class="tight">Miles / Chains:</div></td><td class="np-border"><div id="b-miles" class="tight"></div></td></tr>
          </table>

          <table class="np-border h-grid" style="width:100%; margin-top:10mm; border-collapse:collapse">
            <tr>
              <td class="np-slab np-border" style="width:12%"><div class="tight">SIGNED:</div></td>
              <td class="np-border" style="width:60%"><div id="b-signed-val" class="tight"></div></td>
              <td class="np-slab np-border" style="width:10%"><div class="tight">DATE:</div></td>
              <td class="np-border" style="width:18%"><div id="b-signed-date" class="tight"></div></td>
            </tr>
          </table>

          <div class="np-footer" style="margin-top:6mm;">
            <strong>System Operations – NOP F3.21B</strong><span style="display:inline-block; width:50%"></span><strong>Page:</strong> 1 of 1
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script>
  /* =================== STATIC DATA (unchanged by Supabase) =================== */
  window.ASSETS = [
    {"ID":"1","FIN":"","Controlling SB":"West Hampstead","Location":"Napsbury","Line":"Up Fast","Route":"LN3201","ELR":"SPC1","Mileage":"18.0","Operational Status":"OPERATIONAL"},
    {"ID":"2","FIN":"1","Controlling SB":"West Hampstead","Location":"Napsbury","Line":"Up Slow","Route":"LN3201","ELR":"SPC1","Mileage":"18.0","Operational Status":"DEFECTIVE"},
    {"ID":"3","FIN":"","Controlling SB":"West Hampstead","Location":"Chiltern Green","Line":"Down Slow","Route":"LN3201","ELR":"SPC1","Mileage":"27.69","Operational Status":"OPERATIONAL"},
    {"ID":"4","FIN":"2","Controlling SB":"West Hampstead","Location":"Chiltern Green","Line":"Down Fast","Route":"LN3201","ELR":"SPC1","Mileage":"27.69","Operational Status":"DEFECTIVE"},
    {"ID":"5","FIN":"3","Controlling SB":"West Hampstead","Location":"Oakley","Line":"Up Slow","Route":"LN3201","ELR":"SPC2","Mileage":"53.6","Operational Status":"DEFECTIVE"},
    {"ID":"6","FIN":"4","Controlling SB":"West Hampstead","Location":"Oakley","Line":"Up Fast","Route":"LN3201","ELR":"SPC2","Mileage":"53.6","Operational Status":"DEFECTIVE"},
    {"ID":"7","FIN":"5","Controlling SB":"EMCC","Location":"Finedon","Line":"Down Slow","Route":"LN3201","ELR":"SPC3","Mileage":"67.49","Operational Status":"DEFECTIVE"},
    {"ID":"8","FIN":"","Controlling SB":"EMCC","Location":"Finedon","Line":"Down Fast","Route":"LN3201","ELR":"SPC3","Mileage":"67.49","Operational Status":"OPERATIONAL"},
    {"ID":"9","FIN":"","Controlling SB":"EMCC","Location":"East Langton","Line":"Up Main","Route":"LN3201","ELR":"SPC3","Mileage":"86.26","Operational Status":"OPERATIONAL"},
    {"ID":"10","FIN":"","Controlling SB":"EMCC","Location":"East Langton","Line":"Down Main","Route":"LN3201","ELR":"SPC3","Mileage":"86.26","Operational Status":"OPERATIONAL"},
    {"ID":"11","FIN":"","Controlling SB":"EMCC","Location":"Barrow-On-Soar","Line":"Down Fast","Route":"LN3201","ELR":"SPC5","Mileage":"108.72","Operational Status":"OPERATIONAL"},
    {"ID":"12","FIN":"","Controlling SB":"EMCC","Location":"Barrow-On-Soar","Line":"Down Slow","Route":"LN3201","ELR":"SCP5","Mileage":"108.72","Operational Status":"OPERATIONAL"},
    {"ID":"13","FIN":"","Controlling SB":"EMCC","Location":"Loughborough","Line":"Up Fast","Route":"LN3201","ELR":"SPC5","Mileage":"111.05","Operational Status":"OPERATIONAL"},
    {"ID":"14","FIN":"","Controlling SB":"EMCC","Location":"Loughborough","Line":"Up Slow","Route":"LN3201","ELR":"SPC5","Mileage":"111.05","Operational Status":"OPERATIONAL"},
    {"ID":"15","FIN":"","Controlling SB":"EMCC","Location":"Langley Mill","Line":"Up&Dn Erewash Slow","Route":"LN3207","ELR":"TCC","Mileage":"129.27","Operational Status":"OPERATIONAL"},
    {"ID":"16","FIN":"","Controlling SB":"EMCC","Location":"Langley Mill","Line":"Up Erewash Fast","Route":"LN3207","ELR":"TCC","Mileage":"129.27","Operational Status":"OPERATIONAL"},
    {"ID":"17","FIN":"","Controlling SB":"EMCC","Location":"Belper","Line":"Up Main","Route":"LN3201","ELR":"SPC8","Mileage":"134.68","Operational Status":"OPERATIONAL"},
    {"ID":"18","FIN":"","Controlling SB":"EMCC","Location":"Willington","Line":"Down Main","Route":"LN3501","ELR":"DBP1","Mileage":"6.01","Operational Status":"OPERATIONAL"},
    {"ID":"19","FIN":"","Controlling SB":"EMCC","Location":"Branston","Line":"Up Main","Route":"LN3501","ELR":"DBP1","Mileage":"13.44","Operational Status":"OPERATIONAL"},
    {"ID":"20","FIN":"","Controlling SB":"EMCC","Location":"Geddington","Line":"Down Corby","Route":"LN3601","ELR":"GSM1","Mileage":"77.08","Operational Status":"OPERATIONAL"},
    {"ID":"21","FIN":"","Controlling SB":"EMCC","Location":"Geddington","Line":"Up Corby","Route":"LN3601","ELR":"GSM1","Mileage":"77.08","Operational Status":"OPERATIONAL"},
    {"ID":"22","FIN":"","Controlling SB":"EMCC","Location":"Narborough","Line":"Up Nuneaton","Route":"LN3232","ELR":"WNS","Mileage":"12.17","Operational Status":"OPERATIONAL"},
    {"ID":"23","FIN":"","Controlling SB":"EMCC","Location":"Netherfield","Line":"Up Main","Route":"LN3625","ELR":"NOB1","Mileage":"2.26","Operational Status":"OPERATIONAL"},
    {"ID":"24","FIN":"","Controlling SB":"LSCC","Location":"Tinsleys","Line":"Up Spalding","Route":"LN170","ELR":"WEB","Mileage":"88.58","Operational Status":"OPERATIONAL"},
    {"ID":"25","FIN":"","Controlling SB":"LSCC","Location":"Cheal Road","Line":"Down Spalding","Route":"LN170","ELR":"SPD1","Mileage":"48.32","Operational Status":"OPERATIONAL"},
    {"ID":"26","FIN":"","Controlling SB":"LSCC","Location":"Scopwick","Line":"Up Spalding","Route":"LN170","ELR":"SPD2","Mileage":"70.43","Operational Status":"OPERATIONAL"},
    {"ID":"27","FIN":"","Controlling SB":"LSCC","Location":"Blankney","Line":"Down Spalding","Route":"LN170","ELR":"SPD2","Mileage":"73.21","Operational Status":"OPERATIONAL"},
    {"ID":"28","FIN":"","Controlling SB":"LSCC","Location":"Sykes Lane","Line":"Up Gainsborough","Route":"LN170","ELR":"SPD3","Mileage":"89.17","Operational Status":"OPERATIONAL"},
    {"ID":"29","FIN":"","Controlling SB":"Allignton","Location":"Allington East Jn","Line":"Up Nottingham","Route":"LN195","ELR":"NOG1","Mileage":"108.64","Operational Status":"OPERATIONAL"},
    {"ID":"30","FIN":"","Controlling SB":"EMCC","Location":"Thurmaston","Line":"Up Fast (WILD)","Route":"LN3201","ELR":"SPC5","Mileage":"101.78","Operational Status":"OPERATIONAL"},
    {"ID":"31","FIN":"","Controlling SB":"EMCC","Location":"Thurmaston","Line":"Dn Fast (WILD)","Route":"LN3201","ELR":"SPC5","Mileage":"101.78","Operational Status":"OPERATIONAL"},
    {"ID":"32","FIN":"","Controlling SB":"EMCC","Location":"Thurmaston","Line":"Up&Dn Slow (WILD)","Route":"LN3201","ELR":"SPC5","Mileage":"101.78","Operational Status":"OPERATIONAL"}
  ];
  const ASSETS = window.ASSETS;

  /* FAULTS are the ONLY thing persisted */
  window.FAULTS = [
    {"FIN":"1","ID":"2","Controlling SB":"West Hampstead","Location":"Napsbury","Line":"Up Slow","Route":"LN3201","ELR":"SPC1","Mileage":"18","FMS":"180003","Failure Date":"2022-06-17 00:00:00","Date in order":"","Notes":"Reason unknown"},
    {"FIN":"2","ID":"4","Controlling SB":"West Hampstead","Location":"Chiltern Green","Line":"Down Fast","Route":"LN3201","ELR":"SPC1","Mileage":"27.69","FMS":"179537","Failure Date":"2022-06-04 00:00:00","Date in order":"","Notes":"Awaiting new PC components "},
    {"FIN":"3","ID":"5","Controlling SB":"West Hampstead","Location":"Oakley","Line":"Up Slow","Route":"LN3201","ELR":"SPC2","Mileage":"53.6","FMS":"179531","Failure Date":"2022-06-04 00:00:00","Date in order":"","Notes":"Awaiting new PC components "},
    {"FIN":"4","ID":"6","Controlling SB":"West Hampstead","Location":"Oakley","Line":"Up Fast","Route":"LN3201","ELR":"SPC2","Mileage":"53.6","FMS":"179530","Failure Date":"2022-06-04 00:00:00","Date in order":"","Notes":"Awaiting new PC components "},
    {"FIN":"5","ID":"7","Controlling SB":"EMCC","Location":"Finedon","Line":"Down Slow","Route":"LN3201","ELR":"SPC3","Mileage":"67.49","FMS":"178119","Failure Date":"2022-04-18 00:00:00","Date in order":"","Notes":"Reason unknown"}
  ];
  const FAULTS = window.FAULTS;

  /* ===== Helpers ===== */
  function byId(id){ return ASSETS.find(a => a.ID===id) || null; }
  function getFault(fin){ return FAULTS.find(x => x.FIN===fin) || null; }
  function makeFIN(){
    const nums = FAULTS.map(f => parseInt((f.FIN||"").replace(/\D/g,''),10)).filter(n => !isNaN(n));
    const next = nums.length ? Math.max(...nums)+1 : 1;
    return String(next).padStart(4,'0');
  }
  function stateOf(f){ return (f["Date in order"]||"").trim()==="" ? "Open" : "Closed"; }
  function now(){
    const d=new Date();
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yyyy=d.getFullYear();
    const HH=String(d.getHours()).padStart(2,'0');
    const MM=String(d.getMinutes()).padStart(2,'0');
    return { date: dd+"/"+mm+"/"+yyyy, time: HH+":"+MM };
  }

  function toISOLocal(s){
    if(!s) return "";
    if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}$/.test(s)) return s;
    let m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})/);
    if(m) return `${m[1]}-${m[2]}-${m[3]}T${m[4]}:${m[5]}`;
    m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})[ T](\d{2}):(\d{2})/);
    if(m) return `${m[3]}-${m[2]}-${m[1]}T${m[4]}:${m[5]}`;
    return "";
  }
  function fromISOToParts(iso){
    if(!iso) return {date:"", time:""};
    const m = iso.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2})/);
    if(!m) return {date:"", time:""};
    return { date:`${m[3]}/${m[2]}/${m[1]}`, time:`${m[4]}:${m[5]}` };
  }
  function parseLegacyParts(s){
    if(!s) return {date:"", time:""};
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})[ T](\d{2}):(\d{2})/);
    if(!m) return {date:"", time:""};
    return { date:`${m[1]}/${m[2]}/${m[3]}`, time:`${m[4]}:${m[5]}` };
  }

  function recomputeAssets(){
    ASSETS.forEach(a => {
      const related = FAULTS.filter(f => f.ID===a.ID);
      const open = related.filter(f => stateOf(f)==="Open");
      if(open.length){
        open.sort((x,y) => toISOLocal(y["Failure Date"]||"").localeCompare(toISOLocal(x["Failure Date"]||"")));
        a["Operational Status"] = "Defective";
        a["FIN"] = open[0].FIN || a["FIN"] || "";
      }else{
        a["Operational Status"] = "Operational";
        a["FIN"] = "";
      }
    });
    fillCloseId();
  }

  /* ===== Tabs ===== */
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
      refreshAll();
    });
  });

  /* ===== Overview ===== */
  const OHEAD = ["ID","FIN","Controlling SB","Location","Line","Route","ELR","Mileage","Operational Status"];
  function renderOverview(){
    const q = (document.getElementById('ovr-q').value||"").toLowerCase();
    const list = ASSETS.filter(a => !q || Object.values(a).some(v => String(v).toLowerCase().includes(q)));
    const head = document.getElementById('ovr-head'); head.innerHTML="";
    OHEAD.forEach(h => { const th=document.createElement('th'); th.textContent=h; head.appendChild(th); });
    const body = document.getElementById('ovr-body'); body.innerHTML="";
    list.forEach(a => {
      const tr=document.createElement('tr');
      OHEAD.forEach(k => {
        const td=document.createElement('td');
        if(k==="Operational Status"){
          td.innerHTML = (a[k]||"").toLowerCase().startsWith("defect") ? '<span class="badge r">Defective</span>' : '<span class="badge g">Operational</span>';
        } else {
          td.textContent = a[k]||"";
        }
        tr.appendChild(td);
      });
      body.appendChild(tr);
    });
    document.getElementById('ovr-count').textContent = list.length + " assets";
  }
  document.getElementById('ovr-q').addEventListener('input', renderOverview);

  function labelAsset(a){ return [a.ID, a.Location, a.ELR && ("ELR "+a.ELR), a.Mileage && ("@ "+a.Mileage)].filter(Boolean).join(" — "); }
  function fillBookAsset(){
    const sel = document.getElementById('book-id'); sel.innerHTML="";
    const o=document.createElement('option'); o.value=""; o.textContent="Select asset ID..."; sel.appendChild(o);
    ASSETS.forEach(a => { const opt=document.createElement('option'); opt.value=a.ID; opt.textContent=labelAsset(a); sel.appendChild(opt); });
  }
  function fillCloseId(){
    const sel = document.getElementById('close-id'); sel.innerHTML="";
    const o=document.createElement('option'); o.value=""; o.textContent="Choose ID to bulk close"; sel.appendChild(o);
    const ids = Array.from(new Set(FAULTS.filter(f => stateOf(f)==="Open").map(f => f.ID))).filter(Boolean);
    ids.forEach(id => {
      const a = byId(id) || {};
      const opt=document.createElement('option');
      opt.value=id; opt.textContent = id + " — " + (a.Location||"") + " (" + (FAULTS.filter(f => f.ID===id && stateOf(f)==="Open").length) + " open)";
      sel.appendChild(opt);
    });
  }

  /* ===== Faults table ===== */
  const FHEAD = ["FIN","ID","Controlling SB","Location","Line","Route","ELR","Mileage","FMS","Failure Date","Date in order","Notes","State","Action"];
  function renderFaults(){
    const q=(document.getElementById('flt-q').value||"").toLowerCase();
    const head=document.getElementById('flt-head'); head.innerHTML=""; FHEAD.forEach(h=>{ const th=document.createElement('th'); th.textContent=h; head.appendChild(th); });
    const body=document.getElementById('flt-body'); body.innerHTML="";
    FAULTS.filter(f => !q || Object.values(f).some(v => String(v).toLowerCase().includes(q))).forEach((f) => {
      const tr=document.createElement('tr');
      function tdText(txt){ const td=document.createElement('td'); td.textContent=txt; return td; }
      function tdInput(val, field, type){
        const td=document.createElement('td');
        const inp=document.createElement('input');
        inp.className="fit";
        if(field === "FMS"){ inp.style.minWidth = "112px"; }
        if(field === "Notes"){ inp.style.minWidth = "320px"; }
        if(type==="dt"){
          inp.type="datetime-local";
          inp.value = toISOLocal(val||"");
        } else {
          inp.value = val||"";
        }
        inp.addEventListener('input', () => {
          f[field] = (type==="dt") ? inp.value : inp.value;
          recomputeAssets(); refreshForms(); renderOverview(); renderFaults();
          if(window.queueSave) window.queueSave();
        });
        td.appendChild(inp); return td;
      }
      const a = byId(f.ID)||{};
      tr.appendChild(tdText(f.FIN||""));
      tr.appendChild(tdText(f.ID||""));
      tr.appendChild(tdText(a["Controlling SB"]||f["Controlling SB"]||""));
      tr.appendChild(tdText(a["Location"]||f["Location"]||""));
      tr.appendChild(tdText(a["Line"]||f["Line"]||""));
      tr.appendChild(tdText(a["Route"]||f["Route"]||""));
      tr.appendChild(tdText(a["ELR"]||f["ELR"]||""));
      tr.appendChild(tdText(a["Mileage"]||f["Mileage"]||""));
      tr.appendChild(tdInput(f["FMS"], "FMS"));
      tr.appendChild(tdInput(f["Failure Date"], "Failure Date", "dt"));
      tr.appendChild(tdInput(f["Date in order"], "Date in order"));
      const tdN=document.createElement('td');
      const ta=document.createElement('input');
      ta.className="fit";
      ta.style.minWidth="320px";
      ta.value=f["Notes"]||"";
      ta.addEventListener('input', ()=>{ f["Notes"]=ta.value; refreshForms(); if(window.queueSave) window.queueSave(); });
      tdN.appendChild(ta);
      tr.appendChild(tdN);
      const tdS=document.createElement('td');
      tdS.innerHTML = stateOf(f)==="Open" ? '<span class="badge r">Open</span>' : '<span class="badge g">Closed</span>';
      tr.appendChild(tdS);
      const tdA=document.createElement('td');
      const b=document.createElement('button');
      b.className="btn small no-print";
      b.textContent="Close now";
      b.addEventListener('click', async () => {
        const t=now();
        f["Date in order"]=t.date+" "+t.time;
        recomputeAssets(); refreshForms(); renderOverview(); renderFaults();
        if(window.queueSave) window.queueSave();
        if(document.getElementById('auto-mail-toggle').checked){
          try { await generateAndMailB(f.FIN); } catch(e){ console.warn("Auto B mail failed:", e); }
        }
      });
      tdA.appendChild(b);
      tr.appendChild(tdA);
      body.appendChild(tr);
    });
    document.getElementById('flt-count').textContent = FAULTS.length + " rows";
  }

  function bookFault(){
    const id=(document.getElementById('book-id').value||"").trim();
    const fms=(document.getElementById('book-fms').value||"").trim();
    const failISO=(document.getElementById('book-fail').value||"").trim();
    const notes=(document.getElementById('book-notes').value||"").trim();
    if(!id){ alert("Select an asset ID first."); return; }
    if(!fms){ alert("Enter FMS ref."); return; }
    if(!failISO){ alert("Pick Failure date/time."); return; }
    const fin = makeFIN();
    const a = byId(id) || {};
    FAULTS.unshift({
      "FIN": fin,
      "ID": id,
      "Controlling SB": a["Controlling SB"]||"",
      "Location": a["Location"]||"",
      "Line": a["Line"]||"",
      "Route": a["Route"]||"",
      "ELR": a["ELR"]||"",
      "Mileage": a["Mileage"]||"",
      "FMS": fms,
      "Failure Date": failISO,
      "Date in order": "",
      "Notes": notes
    });
    recomputeAssets();
    renderOverview();
    renderFaults();
    refreshForms();
    if(window.queueSave) window.queueSave();

    if(document.getElementById('auto-mail-toggle').checked){
      generateAndMailA(fin).catch(e => console.warn("Auto A mail failed:", e));
    }
    document.getElementById('book-fms').value="";
    document.getElementById('book-fail').value="";
    document.getElementById('book-notes').value="";
  }

  function closeAllForId(){
    const id=(document.getElementById('close-id').value||"").trim();
    if(!id){ alert("Pick an ID to bulk close."); return; }
    let changed = false;
    const t=now();
    const justClosedFINs = [];
    FAULTS.forEach(f => {
      if(f.ID===id && stateOf(f)==="Open"){
        f["Date in order"] = t.date+" "+t.time;
        changed = true;
        justClosedFINs.push(f.FIN);
      }
    });
    if(changed){
      recomputeAssets();
      refreshForms();
      renderOverview();
      renderFaults();
      if(window.queueSave) window.queueSave();
      if(document.getElementById('auto-mail-toggle').checked){
        Array.from(new Set(justClosedFINs)).forEach(fin => {
          generateAndMailB(fin).catch(e => console.warn("Auto B mail failed:", e));
        });
      }
    }
  }

  /* ===== Forms: selectors & population ===== */
  function openFaults(){ return FAULTS.filter(f => stateOf(f)==="Open"); }
  function closedFaults(){ return FAULTS.filter(f => stateOf(f)==="Closed"); }
  function labelFault(f){
    const a=byId(f.ID)||{};
    const bits=[f.FIN, f.ID, a.Location||f.Location, a.ELR||f.ELR, (a.Mileage||f.Mileage)&&("@ "+(a.Mileage||f.Mileage))].filter(Boolean);
    return bits.join(" — ");
  }
  function fillFIN(selId, list){
    const sel=document.getElementById(selId); sel.innerHTML="";
    const o=document.createElement('option'); o.value=""; o.textContent="Select FIN..."; sel.appendChild(o);
    list.forEach(f => { const opt=document.createElement('option'); opt.value=f.FIN; opt.textContent=labelFault(f); sel.appendChild(opt); });
  }

  function populateFormA(){
    const fin=document.getElementById('a-fin').value;
    const sgn=document.getElementById('a-signed').value||"";
    const f=getFault(fin)||{};
    const a=byId(f.ID||"")||{};
    const t=now();
    document.getElementById('a-uniq').textContent = f.FMS||"";
    const wildIds = new Set(["30","31","32"]);
    document.getElementById('a-x-habd').textContent = wildIds.has(a.ID||"") ? "" : "X";
    document.getElementById('a-x-wild').textContent = wildIds.has(a.ID||"") ? "X" : "";
    document.getElementById('a-time').textContent = t.time;
    document.getElementById('a-date').textContent = t.date;
    document.getElementById('a-route').textContent = a.Route||"";
    document.getElementById('a-elr').textContent   = a.ELR||"";
    document.getElementById('a-loc').textContent   = a.Location||"";
    document.getElementById('a-line').textContent  = a.Line||"";
    document.getElementById('a-miles').textContent = a.Mileage||"";
    document.getElementById('a-signed-val').textContent = sgn;
    document.getElementById('a-signed-date').textContent = t.date;
  }

  function populateFormB(){
    const fin=document.getElementById('b-fin').value;
    const sgn=document.getElementById('b-signed').value||"";
    const f=getFault(fin)||{};
    const a=byId(f.ID||"")||{};
    const t=now();

    document.getElementById('b-uniq').textContent = f.FMS||"";

    const fdISO = toISOLocal(f["Failure Date"]||"");
    if(fdISO){
      const p = fromISOToParts(fdISO);
      document.getElementById('b-from-time').textContent = p.time;
      document.getElementById('b-from-date').textContent = p.date;
    } else {
      const p = parseLegacyParts(f["Failure Date"]||"");
      document.getElementById('b-from-time').textContent = p.time;
      document.getElementById('b-from-date').textContent = p.date;
    }

    const back = (f["Date in order"]||"").trim();
    if(back && back.includes(" ")){
      const [dd, tt] = back.split(" ");
      document.getElementById('b-to-time').textContent = tt||"";
      document.getElementById('b-to-date').textContent = dd||"";
    } else {
      document.getElementById('b-to-time').textContent = t.time;
      document.getElementById('b-to-date').textContent = t.date;
    }

    document.getElementById('b-route').textContent = a.Route||"";
    document.getElementById('b-elr').textContent   = a.ELR||"";
    document.getElementById('b-loc').textContent   = a.Location||"";
    document.getElementById('b-line').textContent  = a.Line||"";
    document.getElementById('b-miles').textContent = a.Mileage||"";
    document.getElementById('b-signed-val').textContent = sgn;
    document.getElementById('b-signed-date').textContent = t.date;
  }

  function refreshForms(){
    fillFIN('a-fin', openFaults());
    fillFIN('b-fin', closedFaults());
    populateFormA();
    populateFormB();
  }

  /* ===== PDF + Email (attachment) ===== */

  async function domToA4PDF(node, filename){
    const opt = {
      margin: [10, 10, 10, 10],
      filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    const blob = await html2pdf().from(node).set(opt).outputPdf('blob');
    return blob;
  }

  function blobToBase64(blob){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onerror = reject;
      reader.onload = () => {
        const base64 = String(reader.result).split(',')[1] || '';
        resolve(base64);
      };
      reader.readAsDataURL(blob);
    });
  }

  async function emailPDFAttachment(blob, filename, subject){
    // Single baked-in recipient
    const recipients = ["bradley.garner@networkrail.co.uk"];
    const base64 = await blobToBase64(blob);
    const { error } = await sb.functions.invoke('send-pdf-email', {
      body: {
        subject,
        to: recipients,
        attachments: [{
          filename,
          contentType: 'application/pdf',
          data_base64: base64
        }]
      }
    });
    if(error) throw new Error(error.message || 'Email function error');
  }

  async function generateAndMailA(fin){
    document.getElementById('a-fin').value = fin;
    populateFormA();
    const node = document.getElementById('formA');
    const filename = `F3.21A-${fin}.pdf`;
    const blob = await domToA4PDF(node, filename);
    if(document.getElementById('auto-mail-toggle').checked){
      await emailPDFAttachment(blob, filename, `F3.21A for FIN ${fin}`);
    }
  }

  async function generateAndMailB(fin){
    document.getElementById('b-fin').value = fin;
    populateFormB();
    const node = document.getElementById('formB');
    const filename = `F3.21B-${fin}.pdf`;
    const blob = await domToA4PDF(node, filename);
    if(document.getElementById('auto-mail-toggle').checked){
      await emailPDFAttachment(blob, filename, `F3.21B for FIN ${fin}`);
    }
  }

  /* ===== CSV + backup ===== */
  function csvDownload(filename, headers, rows){
    function esc(s){ s=(s==null?'':String(s)).replaceAll('"','""'); return '"' + s + '"'; }
    const lines = [headers.map(esc).join(",")].concat(rows.map(r => r.map(esc).join(",")));
    const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8;"});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
  }
  function csvAssets(){
    const q=(document.getElementById('ovr-q').value||"").toLowerCase();
    const headers=["ID","FIN","Controlling SB","Location","Line","Route","ELR","Mileage","Operational Status"];
    const rows = ASSETS.filter(a => !q || Object.values(a).some(v => String(v).toLowerCase().includes(q))).map(a => headers.map(h => a[h]||""));
    csvDownload("overview.csv", headers, rows);
  }
  function csvFaults(){
    const q=(document.getElementById('flt-q').value||"").toLowerCase();
    const headers=["FIN","ID","Controlling SB","Location","Line","Route","ELR","Mileage","FMS","Failure Date","Date in order","Notes","State"];
    const rows = FAULTS.filter(f => !q || Object.values(f).some(v => String(v).toLowerCase().includes(q))).map(f => headers.map(h => {
      if(h==="State") return stateOf(f);
      const a = byId(f.ID)||{};
      return (h in f ? f[h] : a[h]) || "";
    }));
    csvDownload("faultlog.csv", headers, rows);
  }

  function exportBackup(){
    const blob = new Blob([JSON.stringify({faults: FAULTS}, null, 2)], {type:"application/json"});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download = "faults-backup.json";
    a.click();
  }

  function refreshAll(){
    recomputeAssets();
    renderOverview();
    fillBookAsset();
    fillCloseId();
    renderFaults();
    refreshForms();
  }

  // Initial render + listeners
  refreshAll();
  document.getElementById('ovr-q').addEventListener('input', renderOverview);
  document.getElementById('flt-q').addEventListener('input', renderFaults);
  document.getElementById('a-fin').addEventListener('change', populateFormA);
  document.getElementById('b-fin').addEventListener('change', populateFormB);
  document.getElementById('a-signed').addEventListener('input', populateFormA);
  document.getElementById('b-signed').addEventListener('input', populateFormB);
</script>

<!-- === Supabase FAULTS snapshots (append-only) === -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
  const SUPABASE_URL  = "https://ungtmfwxqawkdiflmora.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVuZ3RtZnd4cWF3a2RpZmxtb3JhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDY4NjQsImV4cCI6MjA3NzY4Mjg2NH0.Yaq0XfbbkwxJDUoiPCS7bLVBy70Wa-NOOWIxkpRRxdc";
  window.sb = createClient(SUPABASE_URL, SUPABASE_ANON);

  if (!Array.isArray(window.FAULTS)) window.FAULTS = [];
  const DEFAULT_FAULTS = JSON.parse(JSON.stringify(window.FAULTS || []));

  function applyFaults(faults){
    window.FAULTS.splice(0, window.FAULTS.length, ...(faults || []));
    if (window.refreshAll) window.refreshAll();
  }

  async function loadFaults(){
    const { data, error } = await sb
      .from("fault_snapshots")
      .select("faults")
      .order("created_at", { ascending: false })
      .limit(1);

    if (error) throw error;

    if (!data || !data[0] || !Array.isArray(data[0].faults)) {
      applyFaults(DEFAULT_FAULTS);
      const { error: insErr } = await sb.from("fault_snapshots").insert({ faults: DEFAULT_FAULTS });
      if (insErr) console.warn("Seed insert failed:", insErr.message);
    } else {
      applyFaults(data[0].faults);
    }
  }

  async function saveSnapshot(){
    const faults = Array.isArray(window.FAULTS) ? window.FAULTS : [];
    const { error } = await sb.from("fault_snapshots").insert({ faults });
    if (error) throw error;
  }

  let _t;
  window.queueSave = function queueSave(){
    clearTimeout(_t);
    _t = setTimeout(() => { saveSnapshot().catch(e => alert("Save failed: " + e.message)); }, 800);
  };

  document.addEventListener('DOMContentLoaded', () => {
    loadFaults()
      .then(() => {
        document.querySelectorAll('input, textarea, select')
          .forEach(el => el.addEventListener('input', window.queueSave));
      })
      .catch(e => alert("Load failed: " + e.message));
  });

  window.loadFaults = loadFaults;
  window.saveSnapshot = saveSnapshot;
</script>
</body>
</html>
